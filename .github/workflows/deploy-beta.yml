name: Deployment to server
on:
    push:
        branches: [beta]

jobs:
    build:
        runs-on: self-hosted
        steps:
            - uses: rjstone/discord-webhook-notify@v1
              with:
                  severity: info
                  details: Deployment started...
                  webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
            - uses: actions/checkout@v2
              with:
                  fetch-depth: 0
            - run: |
                  touch .env
                  echo "APP_ENV=beta" >> .env
                  echo "BASE_URL=https://beta.makebetter.app" >> .env
                  echo "API_BASE_URL=https://api.umaestro.fr" >> .env
                  echo "GIT_SHA=${{ github.sha }}" >> .env
                  npm install
                  npm run build
                  cp .env .output/server/.env
                  tar -czf "${GITHUB_SHA}".tar.gz .output
                  sudo mv "${GITHUB_SHA}".tar.gz /var/www/beta_makebetter
                  cd ..
                  rm -rf beta_makebetter_new
                  cp -r beta_makebetter beta_makebetter_new
                  cd beta_makebetter_new
                  git checkout main
                  git reset --hard origin/main
                  git pull
                  npm rebuild
                  npm install
                  npm run build
                  cd ../
                  mv beta_makebetter beta_makebetter_old
                  mv beta_makebetter_new beta_makebetter
                  cd beta_makebetter
                  pm2 delete makebetter-beta
                  pm2 start
                  rm -rf ../beta_makebetter_old

            - uses: rjstone/discord-webhook-notify@v1
              if: success()
              with:
                  severity: info
                  details: Nouvelle version d√©ploy√©e avec succ√®s! ü™Ñ
                  webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
            - uses: rjstone/discord-webhook-notify@v1
              if: failure()
              with:
                  severity: error
                  details: Une erreur est survenue...
                  webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
            - uses: rjstone/discord-webhook-notify@v1
              if: cancelled()
              with:
                  severity: warn
                  details: D√©ploiement annul√©...
                  webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
